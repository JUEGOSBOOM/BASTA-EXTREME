<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASTA EXTREME - FIXED</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --p: #1e272e; --a: #ff3f34; --g: #ffa502; --s: #05c46b; --b: #3d4451; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--p); color: white; text-align: center; margin: 0; padding-bottom: 30px; }
        .hidden { display: none !important; }
        .card { background: #2f3542; padding: 25px; border-radius: 20px; max-width: 450px; margin: 20px auto; box-shadow: 0 10px 25px rgba(0,0,0,0.4); }
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; background: var(--b); padding: 10px; border-radius: 12px; }
        .av-item { font-size: 32px; cursor: pointer; padding: 5px; border-radius: 8px; border: 3px solid transparent; transition: 0.3s; }
        .av-item.selected { border-color: var(--g); background: rgba(255,165,2,0.2); transform: scale(1.1); }
        #timer-banner { position: fixed; top: 0; left: 0; width: 100%; background: var(--a); padding: 12px; font-weight: bold; font-size: 20px; z-index: 5000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        button { padding: 15px; border-radius: 12px; border: none; background: var(--a); color: white; font-weight: bold; cursor: pointer; width: 95%; margin: 8px 0; font-size: 16px; }
        input { padding: 12px; border-radius: 8px; border: none; width: 85%; margin: 10px 0; font-size: 16px; color: #000; }
        .ruleta-txt { font-size: 110px; color: var(--g); font-weight: 900; margin: 10px 0; text-shadow: 0 0 15px var(--g); }
        .in-word-container { margin: 15px 0; text-align: left; width: 90%; margin-left: auto; margin-right: auto; }
        .in-word-container label { font-weight: bold; color: var(--g); display: block; margin-bottom: 5px; }
        .vote-card { background: #1e222b; padding: 15px; border-radius: 15px; margin: 15px 0; border: 1px solid rgba(255,255,255,0.1); }
        #basta-big { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 80px; background: var(--a); padding: 40px; border-radius: 25px; z-index: 9999; font-weight: 900; border: 5px solid white; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
    </style>
</head>
<body>

    <div id="timer-banner" class="hidden"> TIEMPO: <span id="timer-num">20</span>s </div>

    <div id="scr-home" class="card">
        <h1>隆BASTA! EXTREME</h1>
        <input type="text" id="in-name" placeholder="Tu Apodo">
        <p>Elige tu Avatar:</p>
        <div class="avatar-grid" id="av-selector"></div>
        <button onclick="createRoom()">CREAR NUEVA SALA</button>
        <hr style="opacity: 0.2; margin: 20px 0;">
        <input type="text" id="in-code" placeholder="C贸digo de Sala">
        <button onclick="joinRoom()" style="background:var(--s)">UNIRME A SALA</button>
    </div>

    <div id="scr-lobby" class="card hidden">
        <h2 style="margin-top:0">SALA: <span id="room-id-view" style="color:var(--g)"></span></h2>
        <div id="players-lobby" style="margin: 15px 0; font-size: 18px;"></div>
        <div id="cat-container" style="margin-bottom: 20px;"></div>
        <div id="admin-tools" class="hidden">
            <button onclick="startRoulette()" style="background:var(--g); color:black"> GIRAR RULETA Y EMPEZAR</button>
        </div>
        <p id="wait-msg" style="font-style: italic; opacity: 0.7;">Esperando al administrador...</p>
    </div>

    <div id="scr-game" class="card hidden">
        <div id="game-letter" class="ruleta-txt">?</div>
        <div id="game-fields"></div>
        <button id="btn-basta" onclick="pressBasta()" style="background:white; color:black; font-size: 20px; margin-top: 20px;">隆BASTA! (0/0)</button>
    </div>

    <div id="scr-vote" class="card hidden">
        <h2 id="vote-cat-label" style="color:var(--g)"></h2>
        <div id="vote-area"></div>
        <button id="admin-next-cat" class="hidden" onclick="processVoteCategory()" style="background:var(--g); color:black">SIGUIENTE CATEGORA ★</button>
    </div>

    <div id="scr-podium" class="card hidden">
        <h1> RESULTADOS </h1>
        <div id="podium-list" style="font-size: 22px; line-height: 2;"></div>
        <button id="admin-replay" class="hidden" onclick="resetForNewRound()" style="background:var(--s); margin-top:20px">JUGAR OTRA LETRA</button>
    </div>

    <div id="basta-big" class="hidden">隆BASTA!</div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBKDfejC-UxmOggYIuipP-Hw7EL7zphiRg",
            authDomain: "bastaonline-6b254.firebaseapp.com",
            projectId: "bastaonline-6b254",
            storageBucket: "bastaonline-6b254.firebasestorage.app",
            messagingSenderId: "746311436536",
            appId: "1:746311436536:web:ba5ff96347bbbc0952530d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const avatars = ["","","","","","","","","","","",""];
        let myName, myAvatar, rId, isAdmin = false;
        let timerInterval = null;
        let currentStatus = "";

        // Generar avatares al cargar
        const grid = document.getElementById('av-selector');
        avatars.forEach(a => {
            const s = document.createElement('span');
            s.className = 'av-item'; s.innerText = a;
            s.onclick = () => {
                document.querySelectorAll('.av-item').forEach(x => x.classList.remove('selected'));
                s.classList.add('selected'); myAvatar = a;
            };
            grid.appendChild(s);
        });

        function showScreen(id) {
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function createRoom() {
            myName = document.getElementById('in-name').value.trim();
            if(!myName || !myAvatar) return alert("Nombre y Avatar requeridos");
            rId = Math.random().toString(36).substring(2,7).toUpperCase();
            isAdmin = true;
            db.ref('rooms/'+rId).set({
                status: 'lobby', admin: myName,
                categories: ['Nombre', 'Color', 'Cosa', 'Fruta'],
                bastaCount: 0, letter: '?',
                timestamp: Date.now()
            }).then(() => init());
        }

        function joinRoom() {
            myName = document.getElementById('in-name').value.trim();
            rId = document.getElementById('in-code').value.toUpperCase().trim();
            if(!myName || !myAvatar || !rId) return alert("Faltan datos");
            init();
        }

        function init() {
            db.ref(`rooms/${rId}/players/${myName}`).set({ avatar: myAvatar, totalScore: 0, basta: false });
            document.getElementById('room-id-view').innerText = rId;
            
            db.ref('rooms/'+rId).on('value', snap => {
                const data = snap.val(); if(!data) return;
                
                // Control de Admin Tools
                if(isAdmin) {
                    document.getElementById('admin-tools').classList.remove('hidden');
                    document.getElementById('wait-msg').classList.add('hidden');
                }

                // Cambios de estado (Solo si el estado cambi贸)
                if(data.status !== currentStatus) {
                    currentStatus = data.status;
                    if(data.status === 'lobby') { showScreen('scr-lobby'); resetGameState(); }
                    if(data.status === 'playing') { showScreen('scr-game'); renderFields(data); }
                    if(data.status === 'voting') { showScreen('scr-vote'); renderVoting(data); }
                    if(data.status === 'podium') { showScreen('scr-podium'); renderPodium(data); }
                }

                // L贸gica del Timer (Separada del cambio de pantalla)
                if(data.status === 'timer') {
                    startLocalTimer();
                }

                if(data.letter) document.getElementById('game-letter').innerText = data.letter;
                
                // Actualizar contador de jugadores en Lobby y Bot贸n Basta
                if(data.players) {
                    const pList = Object.keys(data.players);
                    document.getElementById('players-lobby').innerHTML = pList.map(p => `${data.players[p].avatar} ${p}`).join(' | ');
                    document.getElementById('btn-basta').innerText = `隆BASTA! (${data.bastaCount || 0}/${pList.length})`;
                    
                    if(data.status === 'lobby') {
                        document.getElementById('cat-container').innerHTML = data.categories.map(c => `<span class="cat-tag">${c}</span>`).join('');
                    }
                }
            });
        }

        function renderFields(data) {
            const area = document.getElementById('game-fields');
            area.innerHTML = ""; // Limpiar siempre
            data.categories.forEach(c => {
                area.innerHTML += `<div class="in-word-container"><label>${c}</label><input type="text" class="in-word" data-cat="${c}" placeholder="Escribe aqu铆..."></div>`;
            });
        }

        function startRoulette() {
            const abc = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            let cycles = 0;
            let int = setInterval(() => {
                db.ref(`rooms/${rId}/letter`).set(abc[Math.floor(Math.random()*abc.length)]);
                if(++cycles > 12) {
                    clearInterval(int);
                    db.ref(`rooms/${rId}`).update({ status: 'playing', bastaCount: 0, answers: null });
                    // Resetear el estado "basta" de todos
                    db.ref(`rooms/${rId}/players`).once('value', s => {
                        s.forEach(p => db.ref(`rooms/${rId}/players/${p.key}/basta`).set(false));
                    });
                }
            }, 100);
        }

        function pressBasta() {
            // Desactivar bot贸n para evitar multi-clic
            document.getElementById('btn-basta').disabled = true;
            
            db.ref(`rooms/${rId}/players/${myName}/basta`).set(true).then(() => {
                db.ref(`rooms/${rId}`).once('value', s => {
                    const d = s.val();
                    const players = Object.values(d.players);
                    const count = players.filter(p => p.basta).length;
                    
                    db.ref(`rooms/${rId}/bastaCount`).set(count);
                    
                    if(count === 1 && d.status !== 'timer') {
                        db.ref(`rooms/${rId}/status`).set('timer');
                    }
                    if(count >= players.length) {
                        stopTimerAndEnd();
                    }
                });
            });
        }

        function startLocalTimer() {
            if(timerInterval) return; 
            document.getElementById('timer-banner').classList.remove('hidden');
            let sec = 20;
            document.getElementById('timer-num').innerText = sec;
            timerInterval = setInterval(() => {
                sec--;
                document.getElementById('timer-num').innerText = sec;
                if(sec <= 0) {
                    stopTimerAndEnd();
                }
            }, 1000);
        }

        function stopTimerAndEnd() {
            if(timerInterval) { clearInterval(timerInterval); timerInterval = null; }
            document.getElementById('timer-banner').classList.add('hidden');
            document.getElementById('basta-big').classList.remove('hidden');
            
            let ans = {};
            document.querySelectorAll('.in-word').forEach(i => {
                ans[i.dataset.cat] = i.value.trim() || "---";
            });
            
            db.ref(`rooms/${rId}/answers/${myName}`).set(ans);

            setTimeout(() => {
                document.getElementById('basta-big').classList.add('hidden');
                if(isAdmin) db.ref(`rooms/${rId}`).update({ status: 'voting', currIdx: 0 });
            }, 2500);
        }

        function renderVoting(data) {
            const cat = data.categories[data.currIdx];
            document.getElementById('vote-cat-label').innerText = "VOTANDO: " + cat.toUpperCase();
            if(isAdmin) document.getElementById('admin-next-cat').classList.remove('hidden');
            
            const area = document.getElementById('vote-area');
            area.innerHTML = '';
            if(!data.answers) return;

            Object.keys(data.answers).forEach(p => {
                const points = (data.players[p].tempScore || 0);
                area.innerHTML += `
                    <div class="vote-card">
                        <h3>${data.players[p].avatar} ${p}</h3>
                        <p style="font-size:24px; font-weight:bold; color:var(--g)">"${data.answers[p][cat]}"</p>
                        <button onclick="addPoint('${p}')" style="background:var(--s); width:auto; padding:10px 20px">+100 PTS</button>
                    </div>`;
            });
        }

        function addPoint(target) {
            db.ref(`rooms/${rId}/players/${target}/totalScore`).transaction(s => (s || 0) + 100);
            alert("Puntos enviados a " + target);
        }

        function processVoteCategory() {
            db.ref(`rooms/${rId}`).once('value', s => {
                const d = s.val();
                if(d.currIdx < d.categories.length - 1) {
                    db.ref(`rooms/${rId}/currIdx`).set(d.currIdx + 1);
                } else {
                    db.ref(`rooms/${rId}/status`).set('podium');
                }
            });
        }

        function renderPodium(data) {
            const sorted = Object.keys(data.players).sort((a,b) => data.players[b].totalScore - data.players[a].totalScore);
            document.getElementById('podium-list').innerHTML = sorted.map((p, i) => `
                <div style="margin:10px; padding:10px; background:rgba(255,255,255,0.1); border-radius:10px;">
                    ${i==0?'':''} ${data.players[p].avatar} <b>${p}</b>: ${data.players[p].totalScore} pts
                </div>
            `).join('');
            if(isAdmin) document.getElementById('admin-replay').classList.remove('hidden');
        }

        function resetForNewRound() {
            db.ref(`rooms/${rId}`).update({ 
                status: 'lobby', 
                answers: null, 
                bastaCount: 0, 
                currIdx: 0, 
                letter: '?' 
            });
        }

        function resetGameState() {
            document.getElementById('game-fields').innerHTML = "";
            document.getElementById('timer-banner').classList.add('hidden');
            document.getElementById('btn-basta').disabled = false;
            if(timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        }
    </script>
</body>
</html>
