
<!DOCTYPE html>
<html lang="es">
<head>  
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASTA EXTREME - RULETA VISUAL</title>
    <link rel="icon" type="image/png" href="BASTA.png">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --p: #1e272e; --a: #ff3f34; --g: #ffa502; --s: #05c46b; --b: #3d4451; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--p); color: white; text-align: center; margin: 0; padding-bottom: 50px; }
        .hidden { display: none !important; }
        .card { background: #2f3542; padding: 25px; border-radius: 20px; max-width: 500px; margin: 20px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Avatares */
        .avatar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 20px 0; background: var(--b); padding: 10px; border-radius: 15px; }
        .av-item { font-size: 30px; cursor: pointer; padding: 5px; border-radius: 10px; border: 3px solid transparent; transition: 0.2s; }
        .av-item.selected { border-color: var(--g); background: rgba(255,165,2,0.3); transform: scale(1.1); }

        /* Timer Banner */
        #timer-banner { position: fixed; top: 0; left: 0; width: 100%; background: var(--a); color: white; padding: 10px; font-size: 24px; font-weight: bold; z-index: 1000; }

        /* Botones e Inputs */
        button { padding: 15px; border-radius: 12px; border: none; background: var(--a); color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; width: 90%; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        input { padding: 12px; border-radius: 8px; border: none; width: 85%; margin: 8px 0; font-size: 16px; outline: none; }
        
        .cat-tag { display: inline-flex; align-items: center; background: var(--b); padding: 5px 12px; border-radius: 20px; margin: 5px; font-size: 14px; }
        .btn-del { color: var(--a); margin-left: 8px; cursor: pointer; font-weight: bold; }

        .ruleta-txt { font-size: 120px; font-weight: 900; color: var(--g); margin: 20px; height: 140px; text-shadow: 0 0 20px var(--g); }

        /* Votaci√≥n */
        .vote-card { background: #1e222b; padding: 15px; border-radius: 15px; margin: 15px 0; position: relative; }
        .vote-btn { width: 60px; background: var(--b); display: inline-block; }
        .vote-btn.selected { background: var(--s); box-shadow: 0 0 15px var(--s); border: 2px solid white; }

        /* Podio */
        .podio-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; margin: 10px 0; border-radius: 12px; background: var(--b); border: 1px solid rgba(255,255,255,0.05); }
        .rank-1 { background: var(--g); color: black; font-weight: bold; box-shadow: 0 0 20px var(--g); }

        /* Overlay Ruleta de Desempate */
        #tie-breaker { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #13171b; border: 4px solid var(--g); padding: 30px; border-radius: 25px; z-index: 3000; min-width: 250px; box-shadow: 0 0 50px black; }
        .blink { animation: blinker 0.5s linear infinite; color: var(--g); font-weight: bold; }
        @keyframes blinker { 50% { opacity: 0; } }
   
.basta-anim {
    animation: popBasta 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes popBasta {
    0% { transform: translate(-50%, -50%) scale(0.2); opacity: 0; }
    50% { transform: translate(-50%, -50%) scale(1.3); }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}
 </style>
</head>
<body>

    <div id="timer-banner" class="hidden">TIEMPO RESTANTE: <span id="timer-num">20</span>s</div>

    <div id="scr-home" class="card">
        <h1>¬°BASTA! EXTREME</h1>
        <input type="text" id="in-name" placeholder="Tu Apodo">
        <h3>Elige Avatar:</h3>
        <div class="avatar-grid" id="av-selector"></div>
        <button onclick="createRoom()">CREAR SALA</button>
        <input type="text" id="in-code" placeholder="C√≥digo de Sala">
        <button onclick="joinRoom()" style="background:var(--s)">UNIRSE</button>
    </div>

    <div id="scr-lobby" class="card hidden">
        <h2>SALA: <span id="room-id-view" style="color:var(--g)"></span></h2>
        <div id="players-lobby" style="margin-bottom:15px; font-weight: bold;"></div>
        <div id="cat-container"></div>
        <div id="admin-tools" class="hidden">
            <input type="text" id="new-cat-in" placeholder="Nueva categor√≠a..." style="width: 60%;">
            <button onclick="addCat()" style="width:20%">+</button>
            <button onclick="startRoulette()" style="background:var(--g); color:black; margin-top:15px">GIRAR RULETA Y JUGAR</button>
        </div>
    </div>

    <div id="scr-game" class="card hidden">
        <div id="game-letter" class="ruleta-txt">?</div>
        <div id="game-fields"></div>
        <button id="btn-basta" onclick="pressBasta()" style="background:white; color:black; font-size:20px">¬°BASTA! (0/0)</button>
    </div>

    <div id="scr-vote" class="card hidden">
        <h2 id="vote-cat-label" style="color:var(--g)">-</h2>
        <div id="vote-area"></div>
        <button id="admin-next-cat" class="hidden" onclick="processVoteCategory()" style="background:var(--g); color:black">SIGUIENTE CATEGOR√çA</button>
    </div>

    <div id="scr-podium" class="card hidden">
        <h1>üèÜ RESULTADOS FINALES</h1>
        <div id="podium-list"></div>
        <button id="admin-replay" class="hidden" onclick="resetForNewRound()" style="background:var(--s)">SIGUIENTE LETRA</button>
    </div>

    <div id="basta-big" class="hidden" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:80px; background:var(--a); padding:40px; border-radius:20px; z-index:2000; font-weight:bold;">¬°BASTA!</div>
    
    <div id="tie-breaker" class="hidden">
        <div class="blink">¬°EMPATE DETECTADO!</div>
        <p>Girando Ruleta de Justicia...</p>
        <div id="tie-result" style="font-size: 50px; font-weight: 900; color: var(--s);">---</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBKDfejC-UxmOggYIuipP-Hw7EL7zphiRg",
            authDomain: "bastaonline-6b254.firebaseapp.com",
            projectId: "bastaonline-6b254",
            storageBucket: "bastaonline-6b254.firebasestorage.app",
            messagingSenderId: "746311436536",
            appId: "1:746311436536:web:ba5ff96347bbbc0952530d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const avatars = ["ü¶ä","üêº","üê∏","ü§ñ","üê±","üê∂","ü¶Å","üêô","üê®","ü¶Ñ","üê∑","üêπ"];
        let myName, myAvatar, rId, isAdmin = false;
        let mySelectedVotes = {};
        let timerInterval = null;

        window.onload = () => {
            const grid = document.getElementById('av-selector');
            avatars.forEach(a => {
                const s = document.createElement('span');
                s.className = 'av-item'; s.innerText = a;
                s.onclick = () => {
                    document.querySelectorAll('.av-item').forEach(x => x.classList.remove('selected'));
                    s.classList.add('selected'); myAvatar = a;
                };
                grid.appendChild(s);
            });
        };

        function createRoom() {
            myName = document.getElementById('in-name').value;
            if(!myName || !myAvatar) return alert("Nombre y Avatar requeridos");
            rId = Math.random().toString(36).substring(2,7).toUpperCase();
            isAdmin = true;
            db.ref('rooms/'+rId).set({
                status: 'lobby', admin: myName,
                categories: ['Nombre', 'Color', 'Cosa', 'Fruta'],
                bastaCount: 0, letter: '?'
            }).then(init);
        }

        function joinRoom() {
            myName = document.getElementById('in-name').value;
            rId = document.getElementById('in-code').value.toUpperCase();
            if(!myName || !myAvatar || !rId) return alert("Faltan datos");
            init();
        }





        
function init() {
    db.ref(`rooms/${rId}/players/${myName}`).set({ avatar: myAvatar, totalScore: 0, basta: false });
    document.getElementById('scr-home').classList.add('hidden');
    document.getElementById('scr-lobby').classList.remove('hidden');
    document.getElementById('room-id-view').innerText = rId;
    if(isAdmin) document.getElementById('admin-tools').classList.remove('hidden');

    db.ref('rooms/'+rId).on('value', snap => {
        const data = snap.val(); if(!data) return;
        
        if(data.letter) document.getElementById('game-letter').innerText = data.letter;

        // --- LIMPIEZA AUTOM√ÅTICA DE RELOJ Y CARTEL ---
        if (data.status !== 'timer' && data.status !== 'playing') {
            document.getElementById('timer-banner').classList.add('hidden');
            document.getElementById('basta-big').classList.add('hidden');
            document.getElementById('basta-big').classList.remove('basta-anim');
            if(timerInterval) { 
                clearInterval(timerInterval); 
                timerInterval = null; 
            }
        }

        if(data.status === 'lobby') { renderLobby(data); resetGameState(); }
        if(data.status === 'playing') renderGame(data);
        if(data.status === 'timer') startLocalTimer(data);
        if(data.status === 'voting') renderVoting(data);
        if(data.status === 'podium') renderPodium(data);
    });
}




        
        function renderLobby(data) {
            document.getElementById('players-lobby').innerHTML = Object.keys(data.players).map(p => `${data.players[p].avatar} ${p}`).join(' | ');
            const cDiv = document.getElementById('cat-container');
            cDiv.innerHTML = '';
            data.categories.forEach((c, idx) => {
                cDiv.innerHTML += `<span class="cat-tag">${c} ${isAdmin ? `<b class="btn-del" onclick="delCat(${idx})">X</b>` : ''}</span>`;
            });
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
            document.getElementById('scr-lobby').classList.remove('hidden');
        }

        function addCat() {
            const v = document.getElementById('new-cat-in').value;
            if(!v) return;
            db.ref(`rooms/${rId}/categories`).once('value', s => {
                let cats = s.val() || []; cats.push(v);
                db.ref(`rooms/${rId}/categories`).set(cats);
                document.getElementById('new-cat-in').value = "";
            });
        }

        function delCat(i) {
            db.ref(`rooms/${rId}/categories`).once('value', s => {
                let cats = s.val(); cats.splice(i,1);
                db.ref(`rooms/${rId}/categories`).set(cats);
            });
        }

        function startRoulette() {
            const abc = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            let cycles = 0;
            let int = setInterval(() => {
                db.ref(`rooms/${rId}/letter`).set(abc[Math.floor(Math.random()*abc.length)]);
                cycles++;
                if(cycles > 15) {
                    clearInterval(int);
                    db.ref(`rooms/${rId}`).update({ status: 'playing', bastaCount: 0 });
                    db.ref(`rooms/${rId}/players`).once('value', s => {
                        s.forEach(p => db.ref(`rooms/${rId}/players/${p.key}/basta`).set(false));
                    });
                }
            }, 100);
        }

        function renderGame(data) {
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
            document.getElementById('scr-game').classList.remove('hidden');
            const area = document.getElementById('game-fields');
            if(area.innerHTML === "") {
                data.categories.forEach(c => {
                    area.innerHTML += `<div><label>${c}</label><br><input type="text" class="in-word" data-cat="${c}"></div>`;
                });
            }
            const total = Object.keys(data.players).length;
            document.getElementById('btn-basta').innerText = `¬°BASTA! (${data.bastaCount || 0}/${total})`;
            
            // SI TODOS PRESIONARON BASTA: MATAR TIMER YA
            if(data.bastaCount >= total) stopTimerAndEnd();
        }

        function pressBasta() {
            db.ref(`rooms/${rId}/players/${myName}/basta`).set(true);
            db.ref(`rooms/${rId}`).once('value', s => {
                const d = s.val();
                let count = Object.values(d.players).filter(p => p.basta).length;
                db.ref(`rooms/${rId}/bastaCount`).set(count);
                if(count === 1 && d.status !== 'timer') db.ref(`rooms/${rId}/status`).set('timer');
                if(count >= Object.keys(d.players).length) stopTimerAndEnd();
            });
        }

        function startLocalTimer(data) {
            renderGame(data);
            if(timerInterval) return;
            document.getElementById('timer-banner').classList.remove('hidden');
            let sec = 20;
            timerInterval = setInterval(() => {
                sec--;
                document.getElementById('timer-num').innerText = sec;
                if(sec <= 0) stopTimerAndEnd();
            }, 1000);
        }



        

function stopTimerAndEnd() {
    if(timerInterval) { 
        clearInterval(timerInterval); 
        timerInterval = null; 
    }
    document.getElementById('timer-banner').classList.add('hidden');
    
    const bastaCartel = document.getElementById('basta-big');
    bastaCartel.classList.remove('hidden');
    bastaCartel.classList.add('basta-anim');
    
    let ans = {};
    document.querySelectorAll('.in-word').forEach(i => {
        ans[i.dataset.cat] = i.value || "---";
        i.value = ""; // Limpia el cuadro para la siguiente letra
    });
    db.ref(`rooms/${rId}/answers/${myName}`).set(ans);

    setTimeout(() => {
        bastaCartel.classList.add('hidden');
        bastaCartel.classList.remove('basta-anim'); 
        if(isAdmin) {
            db.ref(`rooms/${rId}`).update({ status: 'voting', currIdx: 0 });
        }
    }, 1500); 
}

        



        function renderVoting(data) {
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
            document.getElementById('scr-vote').classList.remove('hidden');
            if(isAdmin) document.getElementById('admin-next-cat').classList.remove('hidden');
            
            const cat = data.categories[data.currIdx];
            document.getElementById('vote-cat-label').innerText = cat.toUpperCase();
            
            const area = document.getElementById('vote-area');
            area.innerHTML = '';
            Object.keys(data.answers).forEach(p => {
                const isMe = p === myName;
                const vts = data.votes?.[cat]?.[p] || {};
                let voters = Object.entries(vts).map(([v, pts]) => `${v}(${pts})`).join(', ');

                area.innerHTML += `
                    <div class="vote-card">
                        <h3>${data.players[p].avatar} ${p}</h3>
                        <p style="font-size:22px; color:var(--g)">"${data.answers[p][cat]}"</p>
                        <div ${isMe ? 'style="display:none"' : ''}>
                            <button class="vote-btn ${mySelectedVotes[p]==50?'selected':''}" onclick="sendVote('${p}','${cat}',50)">50</button>
                            <button class="vote-btn ${mySelectedVotes[p]==100?'selected':''}" onclick="sendVote('${p}','${cat}',100)">100</button>
                            <button class="vote-btn ${mySelectedVotes[p]==200?'selected':''}" onclick="sendVote('${p}','${cat}',200)">200</button>
                        </div>
                        <div style="font-size:12px; opacity:0.6; margin-top:5px">Votos: ${voters || '---'}</div>
                    </div>
                `;
            });
        }

        function sendVote(target, cat, pts) {
            mySelectedVotes[target] = pts;
            db.ref(`rooms/${rId}/votes/${cat}/${target}/${myName}`).set(pts);
        }

        async function processVoteCategory() {
            const snap = await db.ref(`rooms/${rId}`).once('value');
            const d = snap.val();
            const cat = d.categories[d.currIdx];
            
            for (let p in d.players) {
                const vArray = Object.values(d.votes?.[cat]?.[p] || {});
                if(vArray.length > 0) {
                    let counts = {};
                    vArray.forEach(v => counts[v] = (counts[v] || 0) + 1);
                    let max = Math.max(...Object.values(counts));
                    let winners = Object.keys(counts).filter(k => counts[k] == max);
                    
                    let final;
                    if(winners.length > 1) {
                        // RULETA VISUAL DE DESEMPATE
                        document.getElementById('tie-breaker').classList.remove('hidden');
                        final = await runTieBreaker(winners);
                        document.getElementById('tie-breaker').classList.add('hidden');
                    } else {
                        final = parseInt(winners[0]);
                    }
                    db.ref(`rooms/${rId}/players/${p}/totalScore`).transaction(c => (c||0) + final);
                }
            }

            if(d.currIdx < d.categories.length - 1) {
                mySelectedVotes = {};
                db.ref(`rooms/${rId}/currIdx`).set(d.currIdx + 1);
            } else {
                db.ref(`rooms/${rId}/status`).set('podium');
            }
        }

        function runTieBreaker(options) {
            return new Promise(resolve => {
                let i = 0;
                const display = document.getElementById('tie-result');
                let int = setInterval(() => {
                    display.innerText = options[i % options.length];
                    i++;
                }, 100);
                
                setTimeout(() => {
                    clearInterval(int);
                    let winner = options[Math.floor(Math.random() * options.length)];
                    display.innerText = winner;
                    setTimeout(() => resolve(parseInt(winner)), 1500);
                }, 2000);
            });
        }

        function renderPodium(data) {
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
            document.getElementById('scr-podium').classList.remove('hidden');
            if(isAdmin) document.getElementById('admin-replay').classList.remove('hidden');
            
            const sorted = Object.keys(data.players).sort((a,b) => data.players[b].totalScore - data.players[a].totalScore);
            const list = document.getElementById('podium-list');
            list.innerHTML = '';
            sorted.forEach((p, i) => {
                list.innerHTML += `
                    <div class="podio-item ${i==0?'rank-1':''}">
                        <span>#${i+1} ${data.players[p].avatar} ${p}</span>
                        <span>${data.players[p].totalScore} pts</span>
                    </div>`;
            });
        }

        function resetForNewRound() {
            db.ref(`rooms/${rId}`).update({ status: 'lobby', answers: null, votes: null, bastaCount: 0, currIdx: 0, letter: '?' });
        }

        


function resetGameState() {
    document.getElementById('game-fields').innerHTML = "";
    document.getElementById('timer-banner').classList.add('hidden');
    document.getElementById('basta-big').classList.add('hidden');
    mySelectedVotes = {};
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = null;
}

            
            
        }
    </script>
</body>

</html>
