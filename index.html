<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASTA EXTREME</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --p: #1e272e; --a: #ff3f34; --g: #ffa502; --s: #05c46b; --b: #3d4451; }
        body { font-family: sans-serif; background: var(--p); color: white; text-align: center; margin: 0; }
        .hidden { display: none !important; }
        .card { background: #2f3542; padding: 20px; border-radius: 15px; max-width: 450px; margin: 20px auto; border: 1px solid rgba(255,255,255,0.1); }
        
        /* Grid de Avatares */
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; padding: 10px; background: var(--b); border-radius: 10px; }
        .av-item { font-size: 30px; cursor: pointer; padding: 5px; border-radius: 8px; border: 3px solid transparent; }
        .av-item.selected { border-color: var(--g); background: rgba(255,165,2,0.2); }

        #timer-banner { position: fixed; top: 0; left: 0; width: 100%; background: var(--a); padding: 10px; font-weight: bold; z-index: 1000; }
        button { padding: 15px; border-radius: 10px; border: none; background: var(--a); color: white; font-weight: bold; cursor: pointer; width: 90%; margin: 5px 0; }
        input { padding: 12px; border-radius: 5px; border: none; width: 80%; margin: 10px 0; display: block; margin-left: auto; margin-right: auto; }
        
        .cat-tag { display: inline-block; background: var(--b); padding: 5px 10px; border-radius: 15px; margin: 5px; }
        .ruleta-txt { font-size: 100px; color: var(--g); font-weight: bold; margin: 20px 0; }
        .vote-card { background: #1e222b; padding: 15px; border-radius: 10px; margin: 10px 0; }
        #basta-big { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 70px; background: var(--a); padding: 30px; border-radius: 15px; z-index: 2000; }
    </style>
</head>
<body>

    <div id="timer-banner" class="hidden">TIEMPO: <span id="timer-num">20</span>s</div>

    <div id="scr-home" class="card">
        <h1>Â¡BASTA!</h1>
        <input type="text" id="in-name" placeholder="Tu Apodo">
        <div class="avatar-grid" id="av-selector"></div>
        <button onclick="createRoom()">CREAR SALA</button>
        <input type="text" id="in-code" placeholder="CÃ³digo">
        <button onclick="joinRoom()" style="background:var(--s)">UNIRSE</button>
    </div>

    <div id="scr-lobby" class="card hidden">
        <h2>SALA: <span id="room-id-view"></span></h2>
        <div id="players-lobby"></div>
        <div id="cat-container"></div>
        <div id="admin-tools" class="hidden">
            <button onclick="startRoulette()" style="background:var(--g); color:black">EMPEZAR JUEGO</button>
        </div>
    </div>

    <div id="scr-game" class="card hidden">
        <div id="game-letter" class="ruleta-txt">?</div>
        <div id="game-fields"></div>
        <button id="btn-basta" onclick="pressBasta()" style="background:white; color:black">Â¡BASTA!</button>
    </div>

    <div id="scr-vote" class="card hidden">
        <h2 id="vote-cat-label"></h2>
        <div id="vote-area"></div>
        <button id="admin-next-cat" class="hidden" onclick="processVoteCategory()">SIGUIENTE</button>
    </div>

    <div id="scr-podium" class="card hidden">
        <h1>RESULTADOS</h1>
        <div id="podium-list"></div>
        <button id="admin-replay" class="hidden" onclick="resetForNewRound()">OTRA RONDA</button>
    </div>

    <div id="basta-big" class="hidden">Â¡BASTA!</div>

    <script>
        // CONFIGURACIÃ“N FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBKDfejC-UxmOggYIuipP-Hw7EL7zphiRg",
            authDomain: "bastaonline-6b254.firebaseapp.com",
            projectId: "bastaonline-6b254",
            storageBucket: "bastaonline-6b254.firebasestorage.app",
            messagingSenderId: "746311436536",
            appId: "1:746311436536:web:ba5ff96347bbbc0952530d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const avatars = ["ðŸ¦Š","ðŸ¼","ðŸ¸","ðŸ¤–","ðŸ±","ðŸ¶","ðŸ¦","ðŸ™","ðŸ¨","ðŸ¦„","ðŸ·","ðŸ¹"];
        let myName, myAvatar, rId, isAdmin = false;
        let timerInterval = null;

        // Cargar Avatares inmediatamente
        const grid = document.getElementById('av-selector');
        avatars.forEach(a => {
            const s = document.createElement('span');
            s.className = 'av-item'; s.innerText = a;
            s.onclick = () => {
                document.querySelectorAll('.av-item').forEach(x => x.classList.remove('selected'));
                s.classList.add('selected'); myAvatar = a;
            };
            grid.appendChild(s);
        });

        function showScreen(id) {
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function createRoom() {
            myName = document.getElementById('in-name').value.trim();
            if(!myName || !myAvatar) return alert("Nombre y Avatar requeridos");
            rId = Math.random().toString(36).substring(2,7).toUpperCase();
            isAdmin = true;
            db.ref('rooms/'+rId).set({
                status: 'lobby', admin: myName,
                categories: ['Nombre', 'Color', 'Cosa', 'Fruta'],
                bastaCount: 0, letter: '?'
            }).then(() => init());
        }

        function joinRoom() {
            myName = document.getElementById('in-name').value.trim();
            rId = document.getElementById('in-code').value.toUpperCase().trim();
            if(!myName || !myAvatar || !rId) return alert("Faltan datos");
            init();
        }

        function init() {
            db.ref(`rooms/${rId}/players/${myName}`).set({ avatar: myAvatar, totalScore: 0, basta: false });
            document.getElementById('room-id-view').innerText = rId;
            if(isAdmin) document.getElementById('admin-tools').classList.remove('hidden');

            db.ref('rooms/'+rId).on('value', snap => {
                const data = snap.val(); if(!data) return;
                
                if(data.status === 'lobby') { showScreen('scr-lobby'); renderLobby(data); resetGameState(); }
                if(data.status === 'playing') { showScreen('scr-game'); renderGame(data); }
                if(data.status === 'timer') { showScreen('scr-game'); startLocalTimer(data); }
                if(data.status === 'voting') { showScreen('scr-vote'); renderVoting(data); }
                if(data.status === 'podium') { showScreen('scr-podium'); renderPodium(data); }

                if(data.letter) document.getElementById('game-letter').innerText = data.letter;
            });
        }

        function renderLobby(data) {
            document.getElementById('players-lobby').innerHTML = Object.keys(data.players).join(' | ');
            document.getElementById('cat-container').innerHTML = data.categories.map(c => `<span class="cat-tag">${c}</span>`).join('');
        }

        function startRoulette() {
            const abc = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            let cycles = 0;
            let int = setInterval(() => {
                db



